{"version":3,"file":"stanz.min.js","sources":["../ofa-error/main.js","../src/public.mjs","../src/watch.mjs","../src/accessor.mjs","../src/array.mjs","../src/main.mjs","../src/base.mjs"],"sourcesContent":["// const error_origin = \"http://127.0.0.1:5793/errors\";\nconst error_origin = \"https://ofajs.github.io/ofa-errors/errors\";\n\n// 存放错误信息的数据对象\nconst errors = {};\n\nif (globalThis.navigator && navigator.language) {\n  fetch(`${error_origin}/${navigator.language.toLowerCase()}.json`)\n    .catch(() => {\n      return fetch(`${error_origin}/default.json`);\n    })\n    .then((e) => e.json())\n    .catch((err) => {\n      console.error(err);\n      return {};\n    })\n    .then((data) => {\n      Object.assign(errors, data);\n    });\n}\n/**\n * 根据键、选项和错误对象生成错误对象。\n *\n * @param {string} key - 错误描述的键。\n * @param {Object} [options] - 映射相关值的选项对象。\n * @param {Error} [error] - 原始错误对象。\n * @returns {Error} 生成的错误对象。\n */\nexport const getErr = (key, options, error) => {\n  const desc = getErrDesc(key, options);\n\n  let errObj;\n  if (error) {\n    errObj = new Error(desc, { cause: error });\n  } else {\n    errObj = new Error(desc);\n  }\n  return errObj;\n};\n\n/**\n * 根据键、选项生成错误描述\n *\n * @param {string} key - 错误描述的键。\n * @param {Object} [options] - 映射相关值的选项对象。\n * @returns {string} 生成的错误描述。\n */\nexport const getErrDesc = (key, options) => {\n  if (!errors[key]) {\n    return `Error code: \"${key}\", please go to https://github.com/ofajs/ofa-errors to view the corresponding error information`;\n  }\n\n  let desc = errors[key];\n\n  // 映射相关值\n  if (options) {\n    for (let k in options) {\n      desc = desc.replace(new RegExp(`{${k}}`, \"g\"), options[k]);\n    }\n  }\n\n  return desc;\n};\n","import { getErr, getErrDesc } from \"../ofa-error/main.js\";\n\nexport const getRandomId = () => Math.random().toString(32).slice(2);\n\nconst objectToString = Object.prototype.toString;\nexport const getType = (value) =>\n  objectToString\n    .call(value)\n    .toLowerCase()\n    .replace(/(\\[object )|(])/g, \"\");\n\nexport const isObject = (obj) => {\n  const type = getType(obj);\n  return type === \"array\" || type === \"object\";\n};\n\nexport const isDebug = {\n  value: null,\n};\n\nif (typeof document !== \"undefined\") {\n  if (document.currentScript) {\n    isDebug.value = document.currentScript.attributes.hasOwnProperty(\"debug\");\n  } else {\n    isDebug.value = true;\n  }\n}\n\nconst TICKERR = \"nexttick_thread_limit\";\n\nlet asyncsCounter = 0;\nlet afterTimer;\nconst tickSets = new Set();\nexport function nextTick(callback) {\n  clearTimeout(afterTimer);\n  afterTimer = setTimeout(() => {\n    asyncsCounter = 0;\n  });\n\n  if (isDebug.value) {\n    Promise.resolve().then(() => {\n      asyncsCounter++;\n      if (asyncsCounter > 100000) {\n        console.log(getErrDesc(TICKERR), \"lastCall => \", callback);\n        throw getErr(TICKERR);\n      }\n\n      callback();\n    });\n    return;\n  }\n\n  const tickId = `t-${getRandomId()}`;\n  tickSets.add(tickId);\n  Promise.resolve().then(() => {\n    asyncsCounter++;\n    // console.log(\"asyncsCounter => \", asyncsCounter);\n    if (asyncsCounter > 50000) {\n      tickSets.clear();\n\n      console.log(getErrDesc(TICKERR), \"lastCall => \", callback);\n      throw getErr(TICKERR);\n    }\n    if (tickSets.has(tickId)) {\n      callback();\n      tickSets.delete(tickId);\n    }\n  });\n  return tickId;\n}\n\n// export const clearTick = (id) => tickSets.delete(id);\n\nexport function debounce(func, wait = 0) {\n  let timeout = null;\n  let hisArgs = [];\n\n  return function (...args) {\n    hisArgs.push(...args);\n\n    if (wait > 0) {\n      clearTimeout(timeout);\n      timeout = setTimeout(() => {\n        func.call(this, hisArgs);\n        hisArgs = [];\n        timeout = null;\n      }, wait);\n    } else {\n      if (timeout === null) {\n        timeout = 1;\n        nextTick(() => {\n          timeout = null;\n          const args = hisArgs.slice();\n          hisArgs = [];\n          func.call(this, args);\n        });\n      }\n    }\n  };\n}\n\n// Enhanced methods for extending objects\nexport const extend = (_this, proto, descriptor = {}) => {\n  [\n    ...Object.getOwnPropertyNames(proto),\n    ...Object.getOwnPropertySymbols(proto),\n  ].forEach((k) => {\n    const result = Object.getOwnPropertyDescriptor(proto, k);\n    const { configurable, enumerable, writable, get, set, value } = result;\n\n    if (\"value\" in result) {\n      if (_this.hasOwnProperty(k)) {\n        _this[k] = value;\n      } else {\n        Object.defineProperty(_this, k, {\n          enumerable,\n          configurable,\n          writable,\n          ...descriptor,\n          value,\n        });\n      }\n    } else {\n      Object.defineProperty(_this, k, {\n        enumerable,\n        configurable,\n        ...descriptor,\n        get,\n        set,\n      });\n    }\n  });\n\n  return _this;\n};\n\nexport function dataRevoked(data) {\n  try {\n    data.xid;\n  } catch (err) {\n    return isRevokedErr(err);\n  }\n\n  return false;\n}\n\nexport function isRevokedErr(error) {\n  const firstLine = error.stack.split(/\\\\n/)[0].toLowerCase();\n  if (firstLine.includes(\"proxy\") && firstLine.includes(\"revoked\")) {\n    return true;\n  }\n\n  return false;\n}\n","import { getRandomId, debounce, dataRevoked } from \"./public.mjs\";\nimport { WATCHS } from \"./main.mjs\";\nconst { assign, freeze } = Object;\n\nclass Watcher {\n  constructor(opts) {\n    assign(this, opts);\n    freeze(this);\n  }\n\n  hasModified(k) {\n    if (this.type === \"array\") {\n      return this.path.includes(this.currentTarget.get(k));\n    }\n\n    const keys = k.split(\".\");\n\n    if (this.currentTarget === this.target && this.name === keys[0]) {\n      return true;\n    }\n\n    const modifieds = getModifieds(this, keys);\n\n    const positionIndex = modifieds.indexOf(this.target);\n    if (positionIndex > -1) {\n      const currentKeys = keys.slice(positionIndex + 1);\n\n      if (!currentKeys.length) {\n        // This is listening for changes in the child object itself\n        return true;\n      }\n\n      return this.name === currentKeys[0];\n    }\n\n    // Data belonging to the chain of change\n    return this.path.includes(this.currentTarget[k]);\n  }\n\n  hasReplaced(k) {\n    if (this.type !== \"set\") {\n      return false;\n    }\n\n    const keys = k.split(\".\");\n\n    if (this.target === this.currentTarget && this.name === keys[0]) {\n      return true;\n    }\n\n    const modifieds = getModifieds(this, keys);\n\n    const positionIndex = modifieds.indexOf(this.target);\n\n    if (positionIndex > -1) {\n      const currentKeys = keys.slice(positionIndex + 1);\n\n      return currentKeys[0] === this.name;\n    }\n\n    return false;\n  }\n}\n\nconst getModifieds = (_this, keys) => {\n  const modifieds = [];\n\n  const cloneKeys = keys.slice();\n  let target = _this.currentTarget;\n  while (cloneKeys.length) {\n    const targetKey = cloneKeys.shift();\n    if (target) {\n      target = target[targetKey];\n    }\n\n    modifieds.push(target);\n  }\n\n  return modifieds;\n};\n\nclass Watchers extends Array {\n  constructor(arr) {\n    super(...arr);\n  }\n\n  hasModified(key) {\n    return this.some((e) => e.hasModified(key));\n  }\n\n  hasReplaced(key) {\n    return this.some((e) => e.hasReplaced(key));\n  }\n}\n\nexport const emitUpdate = ({\n  type,\n  currentTarget,\n  target,\n  name,\n  value,\n  oldValue,\n  args,\n  path = [],\n}) => {\n  if (path && path.includes(currentTarget)) {\n    console.warn(\"Circular references appear\");\n    return;\n  }\n\n  let options = {\n    type,\n    target,\n    name,\n    oldValue,\n    value,\n  };\n\n  if (type === \"array\") {\n    delete options.value;\n    options.args = args;\n  }\n\n  if (currentTarget._hasWatchs) {\n    const watcher = new Watcher({\n      currentTarget,\n      ...options,\n      path: [...path],\n    });\n\n    currentTarget[WATCHS].forEach((func) => {\n      func(watcher);\n    });\n  }\n\n  currentTarget._update &&\n    currentTarget.owner.forEach((parent) => {\n      emitUpdate({\n        currentTarget: parent,\n        ...options,\n        path: [currentTarget, ...path],\n      });\n    });\n};\n\nexport default {\n  watch(callback) {\n    const wid = \"w-\" + getRandomId();\n\n    this[WATCHS].set(wid, callback);\n\n    return wid;\n  },\n\n  unwatch(wid) {\n    return this[WATCHS].delete(wid);\n  },\n\n  watchTick(callback, wait) {\n    return this.watch(\n      debounce((arr) => {\n        if (dataRevoked(this)) {\n          // console.warn(`The revoked object cannot use watchTick : `, this);\n          return;\n        }\n        arr = arr.filter((e) => {\n          try {\n            e.path.forEach((item) => item.xid);\n          } catch (err) {\n            return false;\n          }\n\n          return true;\n        });\n\n        callback(new Watchers(arr));\n      }, wait || 0)\n    );\n  },\n  // For manual use of emitUpdate\n  refresh(opts) {\n    const options = {\n      ...opts,\n      type: \"refresh\",\n      target: this,\n      currentTarget: this,\n    };\n    emitUpdate(options);\n  },\n  watchUntil(func) {\n    return new Promise((resolve) => {\n      let f;\n      const tid = this.watch(\n        (f = () => {\n          const bool = func();\n          if (bool) {\n            this.unwatch(tid);\n            resolve(this);\n          }\n        })\n      );\n\n      f();\n    });\n  },\n};\n","import { isObject } from \"./public.mjs\";\nimport Stanz, { PROXY, isxdata } from \"./main.mjs\";\nimport { emitUpdate } from \"./watch.mjs\";\nimport { getErr, getErrDesc } from \"../ofa-error/main.js\";\n\nconst { defineProperties } = Object;\n\nexport const setData = ({ target, key, value, receiver, type, succeed }) => {\n  const oldValue = receiver[key];\n\n  let data = value;\n  if (isxdata(data)) {\n    if (oldValue === value) {\n      return true;\n    }\n    data._owner.push(receiver);\n  } else if (isObject(value)) {\n    const desc = Object.getOwnPropertyDescriptor(target, key);\n    if (!desc || desc.hasOwnProperty(\"value\")) {\n      data = new Stanz(value);\n      data._owner.push(receiver);\n    }\n  }\n\n  const isSame = oldValue === value;\n\n  if (!isSame && isxdata(oldValue)) {\n    clearData(oldValue, receiver);\n  }\n\n  const reval = succeed(data);\n\n  !isSame &&\n    // __unupdate: Let the system not trigger an upgrade, system self-use attribute\n    !target.__unupdate &&\n    emitUpdate({\n      type: type || \"set\",\n      target: receiver,\n      currentTarget: receiver,\n      name: key,\n      value,\n      oldValue,\n    });\n\n  return reval;\n};\n\nexport const clearData = (val, target) => {\n  if (isxdata(val)) {\n    const index = val._owner.indexOf(target);\n    if (index > -1) {\n      val._owner.splice(index, 1);\n    } else {\n      console.error({\n        desc: \"This data is wrong, the owner has no boarding object at the time of deletion\",\n        target,\n        mismatch: val,\n      });\n    }\n  }\n};\n\nexport const handler = {\n  set(target, key, value, receiver) {\n    if (typeof key === \"symbol\") {\n      return Reflect.set(target, key, value, receiver);\n    }\n\n    // Set properties with _ prefix directly\n    if (/^_/.test(key)) {\n      if (!target.hasOwnProperty(key)) {\n        defineProperties(target, {\n          [key]: {\n            writable: true,\n            configurable: true,\n            value,\n          },\n        });\n      } else {\n        Reflect.set(target, key, value, receiver);\n      }\n      return true;\n    }\n\n    try {\n      return setData({\n        target,\n        key,\n        value,\n        receiver,\n        succeed(data) {\n          return Reflect.set(target, key, data, receiver);\n        },\n      });\n    } catch (error) {\n      const errArgs = [\n        \"failed_to_set_data\",\n        {\n          key,\n        },\n      ];\n\n      console.log(getErrDesc(...errArgs), key, target, value);\n\n      throw getErr(...errArgs, error);\n    }\n  },\n  deleteProperty(target, key) {\n    if (/^_/.test(key) || typeof key === \"symbol\") {\n      return Reflect.deleteProperty(target, key);\n    }\n\n    return setData({\n      target,\n      key,\n      value: undefined,\n      receiver: target[PROXY],\n      type: \"delete\",\n      succeed() {\n        return Reflect.deleteProperty(target, key);\n      },\n    });\n  },\n};\n","import { clearData } from \"./accessor.mjs\";\nimport { SELF, PROXY, isxdata } from \"./main.mjs\";\nimport { isObject } from \"./public.mjs\";\nimport { emitUpdate } from \"./watch.mjs\";\n\nconst mutatingMethods = [\n  \"push\",\n  \"pop\",\n  \"shift\",\n  \"unshift\",\n  \"splice\",\n  \"reverse\",\n  \"sort\",\n  \"fill\",\n  \"copyWithin\",\n];\n\nconst holder = Symbol(\"placeholder\");\n\nfunction compareArrays(oldArray, newArray) {\n  const backupNewArray = Array.from(newArray);\n  const backupOldArray = Array.from(oldArray);\n  const deletedItems = [];\n  const addedItems = new Map();\n\n  const oldLen = oldArray.length;\n  for (let i = 0; i < oldLen; i++) {\n    const oldItem = oldArray[i];\n    const newIndex = backupNewArray.indexOf(oldItem);\n    if (newIndex > -1) {\n      backupNewArray[newIndex] = holder;\n    } else {\n      deletedItems.push(oldItem);\n    }\n  }\n\n  const newLen = newArray.length;\n  for (let i = 0; i < newLen; i++) {\n    const newItem = newArray[i];\n    const oldIndex = backupOldArray.indexOf(newItem);\n    if (oldIndex > -1) {\n      backupOldArray[oldIndex] = holder;\n    } else {\n      addedItems.set(i, newItem);\n    }\n  }\n\n  return { deletedItems, addedItems };\n}\n\nconst fn = {};\n\nconst arrayFn = Array.prototype;\n\nmutatingMethods.forEach((methodName) => {\n  if (arrayFn[methodName]) {\n    fn[methodName] = function (...args) {\n      const backupArr = Array.from(this);\n\n      const reval = arrayFn[methodName].apply(this[SELF], args);\n\n      const { deletedItems, addedItems } = compareArrays(backupArr, this);\n\n      // Refactoring objects as proxy instances\n      for (let [key, value] of addedItems) {\n        if (isxdata(value)) {\n          value._owner.push(this);\n        } else if (isObject(value)) {\n          this.__unupdate = 1;\n          this[key] = value;\n          delete this.__unupdate;\n        }\n      }\n\n      for (let item of deletedItems) {\n        clearData(item, this);\n      }\n\n      emitUpdate({\n        type: \"array\",\n        currentTarget: this,\n        target: this,\n        args,\n        name: methodName,\n        oldValue: backupArr,\n      });\n\n      if (reval === this[SELF]) {\n        return this[PROXY];\n      }\n\n      return reval;\n    };\n  }\n});\n\n// Object.getOwnPropertyNames(Array.prototype).forEach((methodName) => {\n[\"concat\", \"filter\", \"slice\", \"flatMap\", \"map\"].forEach((methodName) => {\n  if (methodName === \"constructor\" || mutatingMethods.includes(methodName)) {\n    return;\n  }\n\n  const oldFunc = Array.prototype[methodName];\n  if (oldFunc instanceof Function) {\n    fn[methodName] = function (...args) {\n      return oldFunc.call(Array.from(this), ...args);\n    };\n  }\n});\n\nexport default fn;\n","import { extend, getRandomId } from \"./public.mjs\";\nimport { handler as stanzHandler } from \"./accessor.mjs\";\nimport arrayFn from \"./array.mjs\";\nimport watchFn from \"./watch.mjs\";\nimport { getErr, getErrDesc } from \"../ofa-error/main.js\";\nconst { defineProperties, getOwnPropertyDescriptor, entries } = Object;\n\nexport const SELF = Symbol(\"self\");\nexport const PROXY = Symbol(\"proxy\");\nexport const WATCHS = Symbol(\"watchs\");\nexport const ISXDATA = Symbol(\"isxdata\");\n\nexport const isxdata = (val) => val && !!val[ISXDATA];\n\nexport function constructor(data, handler = stanzHandler) {\n  // const proxySelf = new Proxy(this, handler);\n  let { proxy: proxySelf, revoke } = Proxy.revocable(this, handler);\n\n  // Determines the properties of the listener bubble\n  proxySelf._update = 1;\n\n  let watchs;\n\n  defineProperties(this, {\n    xid: { value: data.xid || getRandomId() },\n    // Save all parent objects\n    _owner: {\n      value: [],\n    },\n    owner: {\n      configurable: true,\n      get() {\n        return new Set(this._owner);\n      },\n    },\n    [ISXDATA]: {\n      value: true,\n    },\n    [SELF]: {\n      configurable: true,\n      get: () => this,\n    },\n    [PROXY]: {\n      configurable: true,\n      get: () => proxySelf,\n    },\n    // Save the object of the listener function\n    [WATCHS]: {\n      get: () => watchs || (watchs = new Map()),\n    },\n    _hasWatchs: {\n      get: () => !!watchs,\n    },\n    _revoke: {\n      value: revoke,\n    },\n  });\n\n  Object.keys(data).forEach((key) => {\n    const descObj = getOwnPropertyDescriptor(data, key);\n    let { value, get, set } = descObj;\n\n    if (get || set) {\n      defineProperties(this, {\n        [key]: descObj,\n      });\n    } else {\n      // Set the function directly\n      proxySelf[key] = value;\n    }\n  });\n\n  return proxySelf;\n}\n\nexport default class Stanz extends Array {\n  constructor(data) {\n    super();\n\n    return constructor.call(this, data);\n  }\n\n  // This method is still in the experimental period\n  revoke() {\n    const self = this[SELF];\n\n    if (self._onrevokes) {\n      self._onrevokes.forEach((f) => f());\n      self._onrevokes.length = 0;\n    }\n\n    self.__unupdate = 1;\n\n    self[WATCHS].clear();\n\n    entries(this).forEach(([name, value]) => {\n      if (isxdata(value)) {\n        this[name] = null;\n      }\n    });\n\n    self._owner.forEach((parent) => {\n      entries(parent).forEach(([name, value]) => {\n        if (value === this) {\n          parent[name] = null;\n        }\n      });\n    });\n\n    delete self[SELF];\n    delete self[PROXY];\n    self._revoke();\n  }\n\n  toJSON() {\n    let obj = {};\n\n    let isPureArray = true;\n    let maxId = -1;\n\n    Object.keys(this).forEach((k) => {\n      let val = this[k];\n\n      if (!/\\D/.test(k)) {\n        k = parseInt(k);\n        if (k > maxId) {\n          maxId = k;\n        }\n      } else {\n        isPureArray = false;\n      }\n\n      if (isxdata(val)) {\n        val = val.toJSON();\n      }\n\n      obj[k] = val;\n    });\n\n    if (isPureArray) {\n      obj.length = maxId + 1;\n      obj = Array.from(obj);\n    }\n\n    const xid = this.xid;\n    defineProperties(obj, {\n      xid: {\n        get: () => xid,\n      },\n    });\n\n    return obj;\n  }\n\n  toString() {\n    return JSON.stringify(this.toJSON());\n  }\n\n  extend(obj, desc) {\n    return extend(this, obj, desc);\n  }\n\n  get(key) {\n    if (/\\./.test(key)) {\n      const keys = key.split(\".\");\n      let target = this;\n      for (let i = 0, len = keys.length; i < len; i++) {\n        try {\n          target = target[keys[i]];\n        } catch (error) {\n          const errArgs = [\n            \"failed_to_get_data\",\n            {\n              key: keys.slice(0, i).join(\".\"),\n            },\n          ];\n\n          console.log(getErrDesc(...errArgs), \":\", key, this, error);\n\n          throw getErr(...errArgs, error);\n        }\n      }\n\n      return target;\n    }\n\n    return this[key];\n  }\n  set(key, value) {\n    if (/\\./.test(key)) {\n      const keys = key.split(\".\");\n      const lastKey = keys.pop();\n      let target = this;\n      for (let i = 0, len = keys.length; i < len; i++) {\n        try {\n          target = target[keys[i]];\n        } catch (error) {\n          const errArgs = [\n            \"failed_to_get_data\",\n            {\n              key: keys.slice(0, i).join(\".\"),\n            },\n          ];\n\n          console.log(getErrDesc(...errArgs), \":\", key, this, error);\n\n          throw getErr(...errArgs, error);\n        }\n      }\n\n      return (target[lastKey] = value);\n    }\n\n    return (this[key] = value);\n  }\n}\n\nStanz.prototype.extend(\n  { ...watchFn, ...arrayFn },\n  {\n    enumerable: false,\n  }\n);\n","import Stanz, { isxdata } from \"./main.mjs\";\n\nconst stanz = (data) => {\n  return new Stanz(data);\n};\n\nObject.assign(stanz, { is: isxdata });\n\nexport default stanz;\n"],"names":["error_origin","errors","globalThis","navigator","language","fetch","toLowerCase","catch","then","e","json","err","console","error","data","Object","assign","getErr","key","options","desc","getErrDesc","errObj","Error","cause","k","replace","RegExp","getRandomId","Math","random","toString","slice","objectToString","prototype","isObject","obj","type","value","call","isDebug","document","currentScript","attributes","hasOwnProperty","TICKERR","afterTimer","asyncsCounter","tickSets","Set","debounce","func","wait","timeout","hisArgs","args","push","clearTimeout","setTimeout","this","callback","Promise","resolve","log","tickId","add","clear","has","delete","nextTick","freeze","Watcher","constructor","opts","hasModified","path","includes","currentTarget","get","keys","split","target","name","positionIndex","getModifieds","indexOf","currentKeys","length","hasReplaced","_this","modifieds","cloneKeys","targetKey","shift","Watchers","Array","arr","super","some","emitUpdate","oldValue","warn","_hasWatchs","watcher","WATCHS","forEach","_update","owner","parent","watchFn","watch","wid","set","unwatch","watchTick","xid","firstLine","stack","isRevokedErr","dataRevoked","filter","item","refresh","watchUntil","f","tid","defineProperties","setData","receiver","succeed","isxdata","_owner","getOwnPropertyDescriptor","Stanz","isSame","clearData","reval","__unupdate","val","index","splice","mismatch","handler","Reflect","test","writable","configurable","errArgs","deleteProperty","undefined","PROXY","mutatingMethods","holder","Symbol","fn","arrayFn","methodName","backupArr","from","apply","SELF","deletedItems","addedItems","oldArray","newArray","backupNewArray","backupOldArray","Map","oldLen","i","oldItem","newIndex","newLen","newItem","oldIndex","compareArrays","oldFunc","Function","entries","ISXDATA","stanzHandler","watchs","proxy","proxySelf","revoke","Proxy","revocable","_revoke","descObj","self","_onrevokes","toJSON","isPureArray","maxId","parseInt","JSON","stringify","extend","proto","descriptor","getOwnPropertyNames","getOwnPropertySymbols","result","enumerable","defineProperty","len","join","lastKey","pop","stanz","is"],"mappings":"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"}